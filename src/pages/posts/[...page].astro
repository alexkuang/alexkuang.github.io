---
import Link from "src/components/Link.astro";
import Root from "src/layouts/Root.astro";
import { getPosts } from "src/util";
import { render } from "astro:content";
import type { GetStaticPaths } from "astro";

export const getStaticPaths = (async ({ paginate }) => {
  const posts = await getPosts();
  return paginate(posts, { pageSize: 15 });
}) satisfies GetStaticPaths;

const { page } = Astro.props;

const posts = await Promise.all(
  page.data.map(async (p) => ({
    ...p,
    content: await render(p),
  })),
);
---

<Root title="makeshift.computer">
  <div
    class="mt-8 flex flex-col items-center justify-items-center space-y-8 divide-y divide-zinc-200 px-4 pb-8 dark:divide-zinc-700"
  >
    {
      posts.map((post) => (
        <article class="prose w-full pb-8 tracking-tight prose-zinc dark:prose-invert prose-img:mx-auto prose-img:my-auto">
          {post.data.title && (
            <h2>
              <a href={`/posts/${post.id}/`} class="font-semibold no-underline hover:underline">
                {post.data.title}
              </a>
            </h2>
          )}

          {post.data.hasExcerpt ? (
            // default margin on both paragraph + h2 is a bit too spacious for the feed
            <div class="mt-[-1.5em]">
              <div class="line-clamp-6">
                <post.content.Content components={{ a: Link }} />
              </div>
              <p>
                [
                <a href={`/posts/${post.id}/`} class="font-normal no-underline hover:underline">
                  ... more
                </a>
                ]
              </p>
            </div>
          ) : (
            <post.content.Content components={{ a: Link }} />
          )}

          <div class="text-sm">
            {post.publishedAt.minute === 0 && post.publishedAt.second === 0
              ? post.publishedAt.toLocaleString("en-US", { dateStyle: "medium" })
              : post.publishedAt.toLocaleString("en-US", { dateStyle: "medium", timeStyle: "short" })}
          </div>
        </article>
      ))
    }

    <nav class="prose grid w-full grid-cols-3 items-center pt-4 prose-zinc dark:prose-invert">
      <div class="justify-self-start">
        {
          page.url.prev && (
            <a
              href={page.url.prev}
              class="flex items-center gap-1 text-zinc-600 no-underline hover:text-zinc-900 dark:text-zinc-400 dark:hover:text-zinc-100"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 20 20"
                fill="currentColor"
                class="h-5 w-5"
                aria-hidden="true"
              >
                <path
                  fill-rule="evenodd"
                  d="M11.78 5.22a.75.75 0 0 1 0 1.06L8.06 10l3.72 3.72a.75.75 0 1 1-1.06 1.06l-4.25-4.25a.75.75 0 0 1 0-1.06l4.25-4.25a.75.75 0 0 1 1.06 0Z"
                  clip-rule="evenodd"
                />
              </svg>
              Newer
            </a>
          )
        }
      </div>
      <span class="justify-self-center text-zinc-500">
        Page {page.currentPage} of {page.lastPage}
      </span>
      <div class="justify-self-end">
        {
          page.url.next && (
            <a
              href={page.url.next}
              class="flex items-center gap-1 text-zinc-600 no-underline hover:text-zinc-900 dark:text-zinc-400 dark:hover:text-zinc-100"
            >
              Older
              <svg
                xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 20 20"
                fill="currentColor"
                class="h-5 w-5"
                aria-hidden="true"
              >
                <path
                  fill-rule="evenodd"
                  d="M8.22 5.22a.75.75 0 0 1 1.06 0l4.25 4.25a.75.75 0 0 1 0 1.06l-4.25 4.25a.75.75 0 0 1-1.06-1.06L11.94 10 8.22 6.28a.75.75 0 0 1 0-1.06Z"
                  clip-rule="evenodd"
                />
              </svg>
            </a>
          )
        }
      </div>
    </nav>
  </div>
</Root>
